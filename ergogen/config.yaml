meta:
  engine: 4.1.0
  name: SweepyWay
  version: &kb_version v0.2
  author: Happily-Coding
  url: &kb_url https://github.com/Happily-Coding/SweepyWay/

# Define presets that can be selected in the units section to achieve your desired layout.
presets:
  choc_spacing:
    # Standard Choc spacing, compatible with MBK keycaps which are 16.5 x 17.5
    kx: 17 # spacing between keys (X-axis) 
    ky: 18 # spacing between key (Y-axis)  # Will be overwritten by cfx spacing if you use cfx in units extends
    keycap_x_1u: 17.5
    keycap_y_1u: 16.5 # Will be overwritten by cfx spacing if you use cfx in units extends

    px: 5 #10 #3.5 #How much to pad horizontally
    py: 5 #10 #3.5 #how much to pad vertically
    plate_kx: 13.8 # key cutout hole width (cherry, choc v2: 14, choc v1: 13.8)
    plate_ky: 13.8 # key cutout hole height (cherry, choc v2: 14, choc v1: 13.8)
    vertical_diode_shift: 1.5 # How much to shift to avoid overlap
    horizontal_diode_shift: -0.5 plate_kx - 0.85
    diode_rotation: 0
    #diode_rotation: -180 # Diode rotation
    #switch_rotation: 180 # Hotswap south, led north
    
  cfx_spacing: # a preset that can be chosen in the units section, to create a pcb made for chosfox keycaps spacing, which is tighter vertically, allowing you to easily reach the number keys.
    # CFX 1u are 16.5x16.5 keys for a tighter 17x17 matrix.
    $extends: presets.choc_spacing
    kx: 17 # spacing between keys (X-axis) 
    ky: 17 # spacing between keys(Y-axis)
    keycap_x_1u: 16.5
  #pcb_to_case_wall_tolerance: 0.25 <-- asi era ref, debe ser ultra exagerado lo mio.

units:
  $extends: presets.cfx_spacing

  screw_radius: 1.1 # M2 screws
  screw_diameter: screw_radius * 2
  screw_head_radius: 2.05
  screw_head_diameter: screw_head_radius * 2
  spacer_radius: 2.15 # M2 standoffs
  spacer_diameter: spacer_radius * 2
  fillet_radius: 0.5
  via_size: 0.56 # JLCPCB min 0.56 | KiCad default 0.8
  via_drill: 0.3 # JLCPCB min 0.3 | KiCad default 0.4

  # Case variables
  case_wall_thickness: 1.2
  pcb_to_case_wall_tolerance: 0.25
  bottom_plate_thickness: 1.0
  top_plate_thickness: 1.6
  internal_distance_between_plates: 4
  case_border_height: 16 # added by me, in a quick search soffle choic was arround 17 theoretically
  case_bottom_thickness: 3
  screw_offset_x: -0.35 kx #How much to move the screw from the reference point.
  screw_offset_y: -0.35 ky #how much to move the screw from the referene point
  controller_area_height: 5 #How tall relative to the switch plate the controller area cover should be at
  controller_area_wall_thickness: 2 #How thick (wide) the wall of the controller area should be
  controller_area_cover_thickness: 1.6 #How thick (tall) the cover should be 

  # Font units
  font_x: 1
  font_y: 1
  font_xo: 0.5 font_x
  font_yo: 0.5 * font_y

  # Nice Nano
  mcu_spacing_x: 2.72
  mcu_x: 17.78 + mcu_spacing_x
  mcu_y: 33.02
  mcu_xo: 0.5 * mcu_x
  mcu_yo: 0.5 * mcu_y  

  # Battery Connector
  batc_x: 4.3
  batc_y: 4.6
  batc_xo: 0.5 * batc_x
  batc_yo: 0.5 * batc_y

  # Battery Pads
  batp_x: 3.75
  batp_y: 2.5
  batp_xo: 0.5 * batp_x
  batp_yo: 0.5 * batp_y

  # Power Switch
  sw_power_x: 3.1
  sw_power_y: 8.3
  sw_power_xo: 0.5 * sw_power_x
  sw_power_yo: 0.5 * sw_power_y

  # Reset Switch
  sw_reset_x: 3.4
  sw_reset_y: 5
  sw_reset_xo: 0.5 * sw_reset_x
  sw_reset_yo: 0.5 * sw_reset_y

  #How much pcb to generate arround the center of the controller
  #Its better for it to be on the bigger side to ensure there are no gaps between it and the keyboard pcb area
  #As long as you also offset it with negative y it shouldnt be a problem
  controller_sorrounding_x: 50 
  controller_sorrounding_y: 30
  l_controller_area_x_shift: 8
  r_controller_area_x_shift: 8
  l_controller_area_y_shift: -5
  r_controller_area_y_shift: -5
  controller_center_y_shift: -2 #How much to move the center of the controller upward in y
  controller_area_roof_z_thickness: 2 

points:
  key:
    padding: ky
    spread: kx
    width: keycap_x_1u
    height: keycap_x_1u
    mirror:
      tags: ["key", "rightkey"]
  zones:
    matrix:
      # Make placement on kicad sheet fixed
      anchor:
        shift: [35, -150]
      key.tags: [
        "key",
        "leftkey"
        ] #When keys are not mirrored tag them with key, right
      columns:
        col1:
          key.column_net: C1
          key.stagger: 0
          rows:
            row5:
              skip: true
        col2:
          key.column_net: C2
          key.stagger: 0.25 ky
        col3:
          key.column_net: C3
          key.stagger: 0.66 ky
        col4:
          key.column_net: C4
          key.stagger: -0.25 ky
          rows:
            row5:
              skip: true
        col5:
          key.column_net: C5
          key.stagger: -0.15 ky
          rows:
            row5:
              skip: true
        col6:
          key.column_net: C6
          key.stagger: -0.2 ky
          rows:
            row5:
              skip: true
        col7:
          key.column_net: C7
          key.stagger: .2 ky
          rows:
            row1:
              skip: true
            row5:
              skip: true
      rows:
        row5:
          row_net: R5
        row4:
          row_net: R4
        row3:
          row_net: R3
        row2:
          row_net: R2
        row1:
          row_net: R1
      mirror:
        #shift: [35, -150]
        distance: 340

    thumbfan:
      key.tags: ["key", "leftkey"] #When keys are not mirrored tag them with key, right
      anchor:
        ref: matrix_col6_row4
        shift: [-0.66 kx, -1 ky]
        rotate: -10
      columns:
        col1:
          key:
            spread: kx
            column_net: C5
        col2:
          key:
            spread: kx
            splay: -15
            origin: [-0.5 kx, -0.5 ky]
            column_net: C6
        col3:
          key:
            spread: kx
            splay: -5
            origin: [-0.5 kx, -0.5 ky]
            column_net: C7
      rows:
        thumb_row_1:
          row_net: R5
      mirror:
        ref: matrix_col6_row4
        distance: 100
        #200 #mirrors 200 away from the other cluster which isnt right

    controller_center: #The point exactly in the middle of the controller, the controller is drawn arround it
      anchor:
        ref: matrix_col4_row1
        shift: [-0.25*kx, 0.5 ky + mcu_y/2 + controller_center_y_shift]
      key:
        name: mcu #the name that other areas can reference to use as point
        width: mcu_y #Likely the outline of the controller itself but does not affect the area arround it
        height: mcu_x #Likely the outline of the controller itself but does not affect the area arround it
        tags: ["controller_center", "left_controller_center"]
        mirror.tags: ["controller_center", "right_controller_center"]
      mirror:
        ref: matrix_col4_row1
        #shift: [-0.25*kx, 0.5 ky + mcu_y/2 + controller_center_y_shift]
        distance: 165
      #mirror: 200 #Mirrors 200 away from the controller which isnt right

    l_jsph_area_center:
      anchor:
        ref: mcu
        shift: [mcu_x/2 +19, -14]
        rotate: 270
      key:
        tags:
          ['l_jsph_area_center']

    r_jsph_area_center:
      anchor:
        ref: mirror_mcu
        shift: [mcu_x/2 +19, -14]
        rotate: 270
      key:
        tags:
          ['r_jsph_area_center']


    l_controller_area_center:
      anchor:
        ref: mcu
        shift: [l_controller_area_x_shift, l_controller_area_y_shift]
      key:
        tags: ['l_controller_area_center']

    r_controller_area_center:
      anchor:
        ref: mirror_mcu
        shift: [r_controller_area_x_shift, r_controller_area_y_shift]
      key:
        tags: ['r_controller_area_center']
  #Creates the mirror for the entire matrix x units way from the ref
  #mirror: 200 #&mirror
    #ref: matrix_col7_row2
    #shift: [0, + ky]
    #distance: 100
    #key.tags: [key,mirrorkey]
    
    #Define the points at which we need to make each screw hole
    l_screw_left_top:
      anchor:
        - ref: matrix_col1_row1
          shift: [screw_offset_x , screw_offset_y]
      key.tags:
        - left_screw
    l_screw_left_bottom:
      anchor:
        - ref: matrix_col1_row4
          shift: [screw_offset_x , screw_offset_y]
      key.tags:
        - left_screw
    l_screw_right_top:
      anchor:
        - ref: matrix_col6_row1
          shift: [screw_offset_x , screw_offset_y]
      key.tags:
        - left_screw
    l_screw_right_bottom:
      anchor:
        - ref: matrix_col6_row4
          shift: [screw_offset_x , screw_offset_y]
      key.tags:
        - left_screw
    l_screw_thumb:
      anchor:
        - ref: thumbfan_col2_thumb_row_1
          shift: [screw_offset_x , screw_offset_y]
      key.tags:
        - left_screw

outlines:
  l_key_based_board_outline:
    - what: rectangle
      where: leftkey
      #asym: source
      size: [kx + px, ky + py]
      #corner: px #Havig it set to 3.5 (while px was 3.5) made ergogen create a huge arc for some reason. it did not happen with other decimals, nor 3, nor 4
      corner: 3
  
  l_key_based_board_outline_with_extra_padding:
    - what: rectangle
      where: leftkey
      #asym: source
      size: [kx + px + 3, ky + py +3]
      #corner: px #Havig it set to 3.5 (while px was 3.5) made ergogen create a huge arc for some reason. it did not happen with other decimals, nor 3, nor 4
      corner: 3

  r_key_based_board_outline:
    - what: rectangle
      where: rightkey
      #asym: source
      size: [kx + px, ky + py]
      corner: 3
      #corner: px #Havig it set to this value made ergogen create a huge arc for some reason.

  r_key_based_board_outline_with_extra_padding:
    - what: rectangle
      where: rightkey
      #asym: source
      size: [kx + px + 3, ky + py +3]
      #corner: px #Havig it set to 3.5 (while px was 3.5) made ergogen create a huge arc for some reason. it did not happen with other decimals, nor 3, nor 4
      corner: 3

  l_thumb_suplementary_outline:
    - what: polygon
      points:
        - ref: matrix_col6_row4
          shift: [0.5 kx + 0.5px, -0.5 ky + 0.5 py]
        - ref: matrix_col6_row4
          shift: [0.5 kx + 0.5px, -0.5 ky + 0.5 py - 5]
        - ref: thumbfan_col3_thumb_row_1
          shift: [0.5 kx - 0.5px, 0.5 ky + 0.5 py]
        - ref: thumbfan_col3_thumb_row_1
          shift: [0.5 kx - 0.5px, -0.5 ky - 0.5 py]
        - ref: thumbfan_col2_thumb_row_1
          shift: [0.5 kx - 0.5px, -0.5 ky - 0.5 py]
        - ref: thumbfan_col2_thumb_row_1
          shift: [-0.5 kx - 0.5px, -0.5 ky - 0.5 py]
        - ref: thumbfan_col1_thumb_row_1
          shift: [-0.5 kx + 0.5 px, -0.5 ky - 0.5 py]
        - ref: matrix_col2_row4
          shift: [0.5 kx - 0.5 py, -0.5 ky - 0.5 py]
        - ref: matrix_col2_row3
        - ref: matrix_col6_row3

  r_thumb_suplementary_outline:
    - what: polygon
      points:
        - ref: mirror_matrix_col6_row4
          shift: [0.5 kx + 0.5px, -0.5 ky + 0.5 py]
        - ref: mirror_thumbfan_col3_thumb_row_1
          shift: [0.5 kx - 0.5px, 0.5 ky + 0.5 py]
        - ref: mirror_thumbfan_col3_thumb_row_1
          shift: [0.5 kx - 0.5px, -0.5 ky - 0.5 py]
        - ref: mirror_thumbfan_col1_thumb_row_1
          shift: [-0.5 kx + 0.5 px, -0.5 ky - 0.5 py]
        - ref: mirror_matrix_col2_row4
          shift: [0.5 kx - 0.5 py, -0.5 ky - 0.5 py]
        - ref: mirror_matrix_col2_row3
        - ref: mirror_matrix_col6_row3


  l_all_key_clusters_outline:
    - "+l_key_based_board_outline"
    #- "+l_thumb_suplementary_outline"

  r_all_key_clusters_outline:
    - "+r_key_based_board_outline"
  #  - "+r_thumb_suplementary_outline"


  l_controller_area: #The pcb arround the controller (incluiding it)
    - what: rectangle
      where: l_controller_area_center
      size: [controller_sorrounding_x, controller_sorrounding_y]
      corner: 3

  r_controller_area: #The pcb arround the controller (incluiding it)
    - what: rectangle
      where: r_controller_area_center
      size: [controller_sorrounding_x, controller_sorrounding_y]
      corner: 3

  l_controller_area_to_cover_outline:
    - "+l_controller_area"
    - "-l_key_based_board_outline"
  
  l_controler_area_to_not_fill:
    - what: outline
      name: l_controller_area_to_cover_outline
      expand: -2

  l_jsph_area:
    - what: rectangle
      where: l_jsph_area_center
      size: [18, 14]
      corner: 3

  r_jsph_area:
    - what: rectangle
      where: r_jsph_area_center
      size: [18, 14]
      corner: 3

  l_pcb_outline:
    - "+l_key_based_board_outline"
    #- "+l_thumb_suplementary_outline"
    - "+l_controller_area"
    - "+l_jsph_area"

  r_pcb_outline:
    - "+r_key_based_board_outline"
    #- "+r_thumb_suplementary_outline"
    - "+r_controller_area"
    - "+r_jsph_area"

  l_controller_area_cover: #The area that will cover the controller
    - what: outline
      name: l_controller_area
      expand: controller_area_wall_thickness

  r_controller_area_cover: #The area that will cover the controller
    - what: outline
      name: r_controller_area
      expand: controller_area_wall_thickness

  #Create the wall for the left controller area that sits below the area that covers it.
  l_controller_area_border:
    - what: outline
      name: l_controller_area_cover
    - operation: subtract
      what: outline
      name: l_controller_area

  #Create the wall for the left controller area that sits below the area that covers it.
  r_controller_area_border:
    - what: outline
      name: r_controller_area_cover
    - operation: subtract
      what: outline
      name: r_controller_area

  l_jsph_area_cover: #The area that will cover the jsph
    - what: outline
      name: l_jsph_area
      expand: controller_area_wall_thickness

  r_jsph_area_cover: #The area that will cover the jsph
    - what: outline
      name: r_jsph_area
      expand: controller_area_wall_thickness

  #Create the wall for the left jsph area that sits below the area that covers it.
  l_jsph_area_border:
    - what: outline
      name: l_jsph_area_cover
    - operation: subtract
      what: outline
      name: l_jsph_area

  #Create the wall for the left jsph area that sits below the area that covers it.
  r_jsph_area_border:
    - what: outline
      name: r_jsph_area_cover
    - operation: subtract
      what: outline
      name: r_jsph_area

  l_screws_outline:
    - what: circle
      where: [left_screw]
      radius: screw_radius

  r_screws_outline:
    - what: circle
      where: [right_screw]
      radius: screw_radius

  l_case_bottom:
    - what: outline
      name: l_pcb_outline
      expand: 4
    - operation: subtract
      name: l_screws_outline

  r_case_bottom:
    - what: outline
      name: r_pcb_outline
      expand: 4
    - operation: subtract
      name: r_screws_outline

  l_case_border_do_not_ocupy:
    - what: outline
      name: l_pcb_outline
      expand: 2

  r_case_border_do_not_ocupy:
    - what: outline
      name: r_pcb_outline
      expand: 2

  l_case_border:
    #Keep everything to from the border of the case bottom to slightly arround the pcb
    - what: outline
      name: l_case_bottom
    - operation: subtract
      what: outline
      name: l_case_border_do_not_ocupy

  r_case_border:
    #Keep everything to from the border of the case bottom to slightly arround the pcb
    - what: outline
      name: r_case_bottom
    - operation: subtract
      what: outline
      name: r_case_border_do_not_ocupy

  ##### Preparing for tenting system
  l_tenting_base_bottom_outline: ####HERE IS THE PROBLEM
    #Sorround the bottom
    - what: outline
      name: l_case_bottom
      expand: 2
    #And go inward quite a bit to hold the keyboard bottom case
    - what: outline
      name: l_pcb_outline
      operation: subtract
    #- what: outline
    #  name: l_case_bottom
    #  expand : -5
    #  operation: subtract

  r_tenting_base_bottom_outline:
    #Sorround the bottom
    - what: outline
      name: l_case_bottom
      expand: 2
    #And go inward quite a bit to hold the keyboard bottom case
    - what: outline
      name: l_case_bottom
      expand : -5
      operation: subtract

  l_tenting_base_border_outline: ####HERE IS NO PROBLEM
    #Sorround the bottom 
    - what: outline
      name: l_case_bottom
      expand: 2
    #And go inward slightly to generate a wall
    - what: outline
      name: l_case_bottom
      expand : 1
      operation: subtract

  r_tenting_base_border_outline:
    #Sorround the bottom 
    - what: outline
      name: r_case_bottom
      expand: 2
    #And go inward slightly to generate a wall
    - what: outline
      name: r_case_bottom
      expand : 1
      operation: subtract
  #################################

  # l_case_border_outline:
  #   # remove the pcb outline from an outline with exta padding
  #   - name: l_key_based_board_outline_with_extra_padding
  #   - operation: subtract
  #     name: l_key_based_board_outline

  l_keys_outline:
    - what: rectangle
      where: [[leftkey]]
      size: [plate_kx/2, plate_ky/2]

  r_keys_outline:
    - what: rectangle
      where: [[rightkey]]
      size: [plate_kx/2, plate_ky/2]

  l_coverpart_switch_plate_outline: 
  # The top plate of the keyboard with the holes for the key switches bottom to go through and the edges for their middle to sit at.
  #Probably should not use the left pcb outline directly because the MCU is probably taller than the height we want the plate to have
  #And therefore htat should be 
    - name: l_all_key_clusters_outline
    - operation: subtract
      name: l_keys_outline
    - operation: subtract
      name: l_screws_outline

  r_coverpart_switch_plate_outline: 
  # The top plate of the keyboard with the holes for the key switches bottom to go through and the edges for their middle to sit at.
  #Probably should not use the left pcb outline directly because the MCU is probably taller than the height we want the plate to have
  #And therefore htat should be 
    - name: r_all_key_clusters_outline
    - operation: subtract
      name: r_keys_outline
    - operation: subtract
      name: r_screws_outline

  l_cover_outline:
    - name: l_pcb_outline #r_all_key_clusters_outline
    - operation: subtract
      name: l_keys_outline

  r_cover_outline:
    - name: r_pcb_outline #r_all_key_clusters_outline
    - operation: subtract
      name: r_keys_outline

  l_usbc_border_outline:
    - what: rectangle
      where: left_controller_center
      size: [15, 15] #usbc connectors are apparently ~8.94 width, and ~ 4mm high , width is the second value in my file. With 15 a cable fits with the case with room to spare

  r_usbc_border_outline:
    - what: rectangle
      where: right_controller_center
      size: [15, 15] #usbc connectors are apparently ~8.94 width, and ~ 4mm high , width is the second value in my file. With 15 a cable fits with the case with room to spare


  l_hand_rest_overlapping_polygon: #A polygon that extends above the keyboard, from which we need to remove the keyboard in order to make the hand rest polygon.
    - what: polygon
      operation: stack
      points: 
      - ref: matrix_col1_row4
        shift: [-0.5*kx-0.5*px,0] #end at the left border of the key instead of the center
      - ref: matrix_col6_row4
        shift: [0,0]
      - ref: mirror_thumbfan_col1_thumb_row_1
        shift: [0,0]
      - ref: thumbfan_col2_thumb_row_1
        shift: [0,0]
      - ref: thumbfan_col3_thumb_row_1
        shift: [0.5*kx+0.5*px,0]
      - ref: thumbfan_col3_thumb_row_1
        shift: [0.5*kx+0.5*px-5,-50] #make each bottom border end slightly inner in comparison with the original shape, to look better
      - ref: matrix_col1_row4
        shift: [-0.5*kx-0.5*px+5,-50]

  r_hand_rest_overlapping_polygon: #A polygon that extends above the keyboard, from which we need to remove the keyboard in order to make the hand rest polygon.
    - what: polygon
      operation: stack
      points: 
      - ref: mirror_matrix_col1_row4
        shift: [-0.5*kx-0.5*px,0] #end at the left border of the key instead of the center
      - ref: mirror_matrix_col6_row4
        shift: [0,0]
      - ref: mirror_thumbfan_col1_thumb_row_1
        shift: [0,0]
      - ref: mirror_thumbfan_col2_thumb_row_1
        shift: [0,0]
      - ref: mirror_thumbfan_col3_thumb_row_1
        shift: [0.5*kx+0.5*px,0]
      - ref: mirror_thumbfan_col3_thumb_row_1
        shift: [0.5*kx+0.5*px-5,-50] #make each bottom border end slightly inner in comparison with the original shape, to look better
      - ref: mirror_matrix_col1_row4
        shift: [-0.5*kx-0.5*px+5,-50]

  l_hand_rest_polygon:
    - name: l_hand_rest_overlapping_polygon
    - operation: subtract
      name: l_key_based_board_outline_with_extra_padding #l_case_border_outline

  r_hand_rest_polygon:
    - name: r_hand_rest_overlapping_polygon
    - operation: subtract
      name: r_key_based_board_outline_with_extra_padding #r_case_border_outline

  # preview showing outline and keys.
  #combined:
  #  - name: r_cover_outline
    # - operation: stack
    #   name: right_cover_outline


pcbs:
  plate_right:
    template: kicad8
    outlines:
      right:
        outline: r_cover_outline
    footprints:
      jlc:
        what: ceoloide/utility_text
        params:
          text: JLCJLCJLCJLC
          side: B
          mirrored: true
        adjust:
          shift: [0, 6]
        where: 
          - [/^mirror.*/, key, -1_5u, space]
      url:
        what: ceoloide/utility_text
        params:
          text: *kb_url
        adjust:
          shift: [0,-6]
        where: 
          - [/^mirror.*/, key, -1_5u, space]
  plate_left:
    template: kicad8
    outlines:
      right:
        outline: l_coverpart_switch_plate_outline
    footprints:
      url:
        what: ceoloide/utility_text
        params:
          text: *kb_url
        adjust:
          shift: [0,-6]
        where: 
          - [ key, -1_5u, space]
      jlc:
        what: ceoloide/utility_text
        params:
          text: JLCJLCJLCJLC
          side: B
          mirrored: true
        adjust:
          shift: [0, 6]
        where: 
          - [ key, -1_5u, space]
  left_pcb:
    template: kicad8
    outlines:
      left:
        outline: l_pcb_outline
    footprints:
      choc:
        what: ceoloide/switch_choc_v1_v2
        where:
          - [ leftkey]
        adjust:
          rotate: 180
        params:
          include_keycap: true
          choc_v2_support: true
          #          solder: true
          reversible: false
          hotswap: true
          side: 'B'
          keycap_width: 16.5
          keycap_height: 16.5
          include_in_pos_files: true
          from: "{{colrow}}"
          to: "{{column_net}}"
          supplier_link: 'https://kailhswitch.com/products/choc-v1'
          manufacturer_part_number: 'Kailh-Choc-PG1350'
          do_not_populate: ''
          model_filename: "${PATH_TO_SWEEPYWAY_COMPONENT_MODELS}/Choc_V1_Switch.step"
          model_xyz_rotation: [180, 0, 0]
      choc_hotswap:
        what: ceoloide/hs-socket-fab-preview_choc_v1_v2
        where:
          - [ leftkey]
        adjust:
          rotate: 180
        params:
          side: 'B'
          from: "{{colrow}}"
          to: "{{column_net}}"
          # 3D Model
          model_filename: "${PATH_TO_SWEEPYWAY_COMPONENT_MODELS}/Choc_V1_Hotswap.step"
          model_xyz_rotation: [180, 0, 0]
          # Supplier Link (optional)
          supplier_link: 'https://kailhswitch.com/products/hotswap-socket'
          # Manufacturer Part Number (optional)
          manufacturer_part_number: 'Kailh-Hotswap-PG1350'
          # DNP Flag (optional - set to 'DNP' to indicate the manufacturer should not try to place the part automatically)
          do_not_populate: ''
      choc_keycap:
        what: ceoloide/keycap-fab-preview_choc_v1_v2
        where:
          - [ leftkey]
        adjust:
          rotate: 180
        params:
          side: 'B'
          from: "{{colrow}}"
          to: "{{column_net}}"
          # 3D Model
          model_filename: "${PATH_TO_SWEEPYWAY_COMPONENT_MODELS}/Choc_V1_Keycap_MBK_White_1u.step"
          model_xyz_rotation: [180, 0, 0]
          model_xyz_offset: [0, 0, -7] #third axis is vertical
          # Supplier Link (optional)
          supplier_link: 'https://mechanicalkeyboards.com/product/mbk-choc'
          # Manufacturer Part Number (optional)
          manufacturer_part_number: 'MBK-Choc-1u-White'
          # DNP Flag (optional - set to 'DNP' to indicate the manufacturer should not try to place the part automatically)
          do_not_populate: 'DNP'
      choc_space:
        what: ceoloide/switch_choc_v1_v2
        where:
          - [ leftkey, -1_5u, space]
        adjust:
          rotate: 180
        params:
          include_keycap: true
          choc_v2_support: true
          #solder: true
          reversible: false
          hotswap: true
          side: 'B'
          keycap_width: keycap_x_space
          keycap_height: 16.5
          include_in_pos_files: true
          from: "{{colrow}}"
          to: "{{column_net}}"
          # Supplier Links (optional)
          supplier_link: 'https://kailhswitch.com/products/choc-v1'
          # Manufacturer Part Numbers (optional)
          manufacturer_part_number: 'Kailh-Choc-PG1350'
          # DNP Flag (optional - set to 'DNP' to indicate the manufacturer should not try to place the part automatically)
          do_not_populate: ''
          # 3D Models
          model_filename: "${PATH_TO_SWEEPYWAY_COMPONENT_MODELS}/Choc_V1_Switch.step"
          model_xyz_rotation: [180, 0, 0]
      diode:
        what: ceoloide/diode_tht_sod123
        where:
          - leftkey
        params:
          from: "{{colrow}}"
          to: "{{row_net}}"
          side: F
          include_tht: false
          reversible: false
          diode_3dmodel_filename: "${PATH_TO_SWEEPYWAY_COMPONENT_MODELS}/D_SOD-123.step"
          diode_3dmodel_xyz_offset: [0, 0, 0]
          diode_3dmodel_xyz_scale: [1, 1, 1]
          diode_3dmodel_xyz_rotation: [0, 0, 0]
        adjust:
          shift: [horizontal_diode_shift,vertical_diode_shift]
          rotate: 90 + diode_rotation

      promicro:
        what: ceoloide/mcu_nice_nano
        params:
          reverse_mount: true
          include_extra_pins: true
          mcu_3dmodel_filename: "${PATH_TO_SWEEPYWAY_COMPONENT_MODELS}/Nice_Nano_V2.step"
          mcu_3dmodel_xyz_offset: [0, 0, 5]
          mcu_3dmodel_xyz_scale: [1, 1, 1]
          mcu_3dmodel_xyz_rotation: [0, 0, 0]
          # Pin Assignments (Controller on top facing down)
          # Right Side
          P0: "DPD" # Display Data
          P1: "DPC" # Display Clock
          # GND
          # GND
          P2: "DPE" # Display CS (nice!view only) FIXME? ZPM default?
          #MODIFIED
          # Creo que tal vez la lcave no es separarlos si no poner bien al borde los de rows, empezando mas afuera los de mas abajo y
          #los de columns si lo mas separados posibles para el lugar correcot.
          P3: "R2" # Row
          P4: "R3" # Row
          P5: "R5" # Row
          P6: "R4" # Row
          P7: "R7" # Row
          P8: "R6" # Row
          P9: "R5" # Row

          # Left Side
          # RAW:      # Battery Pos
          # GND       # Ground / Battery Neg
          # RST       # Reset pin
          # VCC       # External Power
          P21: "C1" # Column
          P20: "C2" # Column
          P19: "C3" # Column
          P18: "C4" # Column
          P15: "C5" # Column
          P14: "C6" # Column
          P16: "C7" # Column
          # P10: "F10" # Free
        adjust:
          rotate: 90
        where:
          ref: mcu
      pads_bat:
        what: ceoloide/battery_connector_jst_ph_2
        params:
          connector_3dmodel_filename: "${PATH_TO_SWEEPYWAY_COMPONENT_MODELS}/JSTPH2-S2B-PH-K-S-LF-SN.step"
          connector_3dmodel_xyz_rotation: [-90,0,0]
          connector_3dmodel_xyz_offset: [0,1.5,0]
        where:
          ref: mcu
          shift: [mcu_x/2 +22, -10]
          rotate: 270
      reset:
        what: ceoloide/reset_switch_smd_side
        params:
          side: F #The same side that most switches height are, to avoid adding unnecessary height
          from: GND
          to: RST
          model_filename: "${PATH_TO_SWEEPYWAY_COMPONENT_MODELS}/EVQ-PUC02K.stp"
          model_xyz_offset: [0, 0, 0]
          model_xyz_rotation: [180, 180, 0]
        adjust:
          rotate: 270
        where:
          ref: mcu
          shift: [mcu_x/2 +18 +2, -0]
      power:
        what: ceoloide/power_switch_smd_side
        params:
          side: F #The same side that most switches height are, to avoid adding unnecessary height
          #          from: GND
          #          to: RST
          model_filename: "${PATH_TO_SWEEPYWAY_COMPONENT_MODELS}/SSSS811101--3DModel-STEP-269445.STEP"
          model_xyz_offset: [0, 0, 0]
          model_xyz_rotation: [90, 180, 90]
        adjust:
          rotate: 90
        where:
          ref: mcu
          shift: [mcu_x/2 +16, 8]
      # url:
      #   what: ceoloide/utility_text
      #   params:
      #     text: *kb_url
      #     reversible: true
      #   adjust:
      #     shift: [0,-6]
      #   where: 
      #     - [key, -1_5u, space]
      # version:
      #   what: ceoloide/utility_text
      #   params:
      #     text: *kb_version
      #   adjust:
      #     shift: [0,-6]
      #   where: 
      #     ref: mcu
      #     shift: [-mcu_y/2 -22,  -2]
      jlc:
        what: ceoloide/utility_text
        params:
          text: JLCJLCJLCJLC
          side: F
        adjust:
          shift: [0, 10]
        where: 
          - [key, -1_5u, space]
      screws:
        what: ceoloide/mounting_hole_npth
        where: left_screw
        params:
          hole_size: screw_diameter
          hole_drill: screw_diameter

  right_pcb:
    template: kicad8
    outlines:
      right:
        outline: r_pcb_outline
    footprints:
      choc:
        what: ceoloide/switch_choc_v1_v2
        where:
          - [/^mirror.*/, key, -1_5u, -space]
          - /rightcluster_.*/
        adjust:
          rotate: 180
        params:
          include_keycap: true
          choc_v2_support: true
          #solder: true
          reversible: false
          hotswap: true
          side: 'B'
          keycap_width: 16.5
          keycap_height: 16.5
          include_in_pos_files: true
          from: "{{colrow}}"
          to: "{{column_net}}"
          supplier_link: 'https://kailhswitch.com/products/choc-v1'
          manufacturer_part_number: 'Kailh-Choc-PG1350'
          do_not_populate: ''
          model_filename: "${PATH_TO_SWEEPYWAY_COMPONENT_MODELS}/Choc_V1_Switch.step"
          model_xyz_rotation: [180, 0, 0]
      choc_hotswap:
        what: ceoloide/hs-socket-fab-preview_choc_v1_v2
        where:
          - [/^mirror.*/, key, -1_5u, -space]
          - /rightcluster_.*/
        adjust:
          rotate: 180
        params:
          side: 'B'
          from: "{{colrow}}"
          to: "{{column_net}}"
          model_filename: "${PATH_TO_SWEEPYWAY_COMPONENT_MODELS}/Choc_V1_Hotswap.step"
          model_xyz_rotation: [180, 0, 0]
          supplier_link: 'https://kailhswitch.com/products/hotswap-socket'
          manufacturer_part_number: 'Kailh-Hotswap-PG1350'
          do_not_populate: ''
      choc_keycap:
        what: ceoloide/keycap-fab-preview_choc_v1_v2
        where:
          - [/^mirror.*/, key, -1_5u, -space]
          - /rightcluster_.*/
        adjust:
          rotate: 180
        params:
          side: 'B'
          from: "{{colrow}}"
          to: "{{column_net}}"
          # 3D Model
          model_filename: "${PATH_TO_SWEEPYWAY_COMPONENT_MODELS}/Choc_V1_Keycap_MBK_White_1u.step"
          model_xyz_rotation: [180, 0, 0]
          model_xyz_offset: [0, 0, -7] #third axis is vertical
          # Supplier Link (optional)
          supplier_link: 'https://mechanicalkeyboards.com/product/mbk-choc'
          # Manufacturer Part Number (optional)
          manufacturer_part_number: 'MBK-Choc-1u-White'
          # DNP Flag (optional - set to 'DNP' to indicate the manufacturer should not try to place the part automatically)
          do_not_populate: 'DNP'
      choc_space:
        what: ceoloide/switch_choc_v1_v2
        where:
          - [/^mirror.*/, key, -1_5u, space]
        adjust:
          rotate: 180
        params:
          include_keycap: true
          choc_v2_support: true
          #solder: true
          reversible: false
          hotswap: true
          side: 'B'
          keycap_width: keycap_x_space
          keycap_height: 16.5
          include_in_pos_files: true
          from: "{{colrow}}"
          to: "{{column_net}}"
          # Supplier Links (optional)
          supplier_link: 'https://kailhswitch.com/products/choc-v1'
          # Manufacturer Part Numbers (optional)
          manufacturer_part_number: 'Kailh-Choc-PG1350'
          # DNP Flag (optional - set to 'DNP' to indicate the manufacturer should not try to place the part automatically)
          do_not_populate: ''
          # 3D Models
          model_filename: "${PATH_TO_SWEEPYWAY_COMPONENT_MODELS}/Choc_V1_Switch.step"
          model_xyz_rotation: [180, 0, 0]
      diode:
        what: ceoloide/diode_tht_sod123
        where:
          - rightkey
        params:
          from: "{{colrow}}"
          to: "{{row_net}}"
          side: F
          include_tht: false
          reversible: false
          diode_3dmodel_filename: "${PATH_TO_SWEEPYWAY_COMPONENT_MODELS}/D_SOD-123.step"
          diode_3dmodel_xyz_offset: [0, 0, 0]
          diode_3dmodel_xyz_scale: [1, 1, 1]
          diode_3dmodel_xyz_rotation: [0, 0, 0]
        adjust:
          shift: [horizontal_diode_shift,vertical_diode_shift]
          rotate: 90 + diode_rotation

      promicro:
        what: ceoloide/mcu_nice_nano
        params:
          reverse_mount: true
          include_extra_pins: true
          mcu_3dmodel_filename: "${PATH_TO_SWEEPYWAY_COMPONENT_MODELS}/Nice_Nano_V2.step"
          mcu_3dmodel_xyz_offset: [0, 0, 5]
          mcu_3dmodel_xyz_scale: [1, 1, 1]
          mcu_3dmodel_xyz_rotation: [0, 0, 0]
          # Pin Assignments (Controller on top facing down)
          # Right Side
          P0: "DPD" # Display Data
          P1: "DPC" # Display Clock
          # GND
          # GND
          P2: "DPE" # Display CS (nice!view only) FIXME? ZPM default?
          P3: "R2" # Row
          P4: "R3" # Row
          P5: "R4" # Row
          P6: "R5" # Row
          P7: "R5" # Row
          P8: "R6" # Row
          P9: "R7" # Row

          # Left Side
          # RAW:      # Battery Pos
          # GND       # Ground / Battery Neg
          # RST       # Reset pin
          # VCC       # External Power
          P21: "C1" # Column
          P20: "C2" # Column
          P19: "C3" # Column
          P18: "C4" # Column
          P15: "C5" # Column
          P14: "C6" # Column
          P16: "C7" # Column
          # P10: "C7" # Column
        adjust:
          rotate: 90
        where:
          ref: mirror_mcu

      pads_bat:
        what: ceoloide/battery_connector_jst_ph_2
        params:
          connector_3dmodel_filename: "${PATH_TO_SWEEPYWAY_COMPONENT_MODELS}/JSTPH2-S2B-PH-K-S-LF-SN.step"
        where:
          ref: mirror_mcu
          shift: [mcu_x/2 +22, -10]
          rotate: 270
      reset:
        what: ceoloide/reset_switch_smd_side
        params:
          side: F #The same side that most switches height are, to avoid adding unnecessary height
          from: GND
          to: RST
          model_filename: "${PATH_TO_SWEEPYWAY_COMPONENT_MODELS}/EVQ-PUC02K.stp"
          model_xyz_offset: [0, 0, 0]
          model_xyz_scale: [1, 1, 1]
          model_xyz_rotation: [180, 180, 0]
        adjust:
          rotate: 270
        where:
          ref: mirror_mcu
          shift: [mcu_x/2 +18 +2, -0]
      power:
        what: ceoloide/power_switch_smd_side
        params:
          side: F
          #          from: GND
          #          to: RST
          model_filename: "${PATH_TO_SWEEPYWAY_COMPONENT_MODELS}/SSSS811101--3DModel-STEP-269445.STEP"
          model_xyz_offset: [0, 0, 0]
          model_xyz_scale: [1, 1, 1]
          model_xyz_rotation: [90, 180, 90]
        adjust:
          rotate: 270
        where:
          ref: mirror_mcu
          shift: [mcu_x/2 +16, 8]
      url:
        what: ceoloide/utility_text
        params:
          text: *kb_url
          reversible: true
        adjust:
          shift: [0,-6]
        where: 
          - [/^mirror.*/, key, -1_5u, space]

      jlc:
        what: ceoloide/utility_text
        params:
          text: JLCJLCJLCJLC
          side: F
        adjust:
          shift: [0, 10]
        where: 
          - [/^mirror.*/, key, -1_5u, space]
      # version:
      #   what: ceoloide/utility_text
      #   params:
      #     text: *kb_version
      #   adjust:
      #     shift: [0,-6]
      #   where: 
      #     ref: mirror_mcu
      #     shift: [-mcu_y/2 -22,  -2]

cases:
  #We need to do something like this for the bottom plate:
  #left_plate_3d:
  #  - name: l_bottom_plate_outline #ref to extrude
  #    extrude: 1.2

  l_case_3d:
    - name: l_case_bottom #l_key_based_board_outline_with_extra_padding
      extrude: case_bottom_thickness
    - name: l_case_border #l_case_border_outline
      extrude: case_border_height
    - name : l_usbc_border_outline
      extrude: 10 #10 More than necessary for a cable to fit with the border inside the case, but i use 12 for more leeway just in case
      shift: [-20,5,case_bottom_thickness]
      operation: subtract

  l_cover:
    - name: l_coverpart_switch_plate_outline #Create the switch plate
      extrude: top_plate_thickness
      shift: [0, 0, 25]
    - name: l_controller_area_to_cover_outline #create the controller housing
      extrude: controller_area_height
      shift: [0, 0, 25]
    - name: l_controler_area_to_not_fill #Make the controller housing hollow
      extrude: controller_area_height
      operation: subtract
      shift: [0, 0, 25]
    - name: l_controller_area_to_cover_outline #Add a roof to the controller housing
      extrude: controller_area_roof_z_thickness
      shift: [0, 0, 25+ controller_area_height]

  l_3d_preview:
    #Pasting all components here with vertical offsets we can verify that everything fits where it should
    - name: l_case_bottom #l_key_based_board_outline_with_extra_padding
      extrude: case_bottom_thickness
    - name: l_case_border #l_case_border_outline
      extrude: case_border_height
    - name : l_usbc_border_outline
      extrude: 10 #10 More than necessary for a cable to fit with the border inside the case, but i use 12 for more leeway just in case
      shift: [-20,5,case_bottom_thickness]
      operation: subtract
    - name: l_coverpart_switch_plate_outline
      extrude: 3
      shift: [0, 0, 25]

    #Components that shoulndt really be printed
    - name: l_pcb_outline
      shift: [0, 0, 20]

    #- name: l_hand_rest_polygon #This has an odd shape but i dont think we need to worry, it does not actually represent the polygon
    #  extrude: 3
    #  shift: [0, 0, 0]

    # - name: l_hand_rest_overlapping_polygon # test
    #   extrude: 3
    #   shift: [0,0, 30]
