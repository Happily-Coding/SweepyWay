# Fix Plan for STL to ASCII Conversion Error

## Problem Summary

The GitHub Actions workflow is failing when converting binary STL files to ASCII STL format. The error occurs in `kibot/stl2ascii.py` at line 39:

```
struct.error: unpack requires a buffer of 12 bytes
```

This error indicates that the code is trying to read 12 bytes (3 floats * 4 bytes each) from the file, but there aren't enough bytes available. This suggests the STL file is either empty, corrupted, or not properly generated.

## Root Cause Analysis

The error `struct.error: unpack requires a buffer of 12 bytes` indicates that the code is trying to read 12 bytes (3 floats × 4 bytes each) from the file, but there aren't enough bytes available. This suggests the STL file is either:

1. **Empty** - The file exists but has no data
2. **Corrupted** - The file was not properly generated
3. **Not generated** - The 3D model export step failed silently

Looking at the workflow in [`.github/workflows/build.yaml:65-77`](.github/workflows/build.yaml:65-77), the STL files are generated by KiBot's 3D preview step before the conversion script runs. If the 3D preview step fails or produces empty files, the conversion will fail.

### Current Implementation Issues

The current [`kibot/stl2ascii.py`](kibot/stl2ascii.py) has no error handling for:
- Empty or malformed STL files
- Insufficient data to read
- File I/O errors

## Solution

The fix requires three components:

### 1. Add Robust Error Handling to stl2ascii.py

```python
def read_binary_stl(filename):
    """Read binary STL file and return list of facets."""
    with open(filename, 'rb') as f:
        # Read header (80 bytes)
        header = f.read(80)

        # Check if header is empty
        if len(header) < 80:
            raise ValueError(f"Invalid STL file: {filename} - header is too short")

        # Read number of facets (4 bytes, little endian)
        num_facets_data = f.read(4)
        if len(num_facets_data) < 4:
            raise ValueError(f"Invalid STL file: {filename} - facet count is too short")
        num_facets = struct.unpack('<I', num_facets_data)[0]

        # Validate facet count - reasonable PCB models should have far fewer facets
        # A typical PCB with 1000-5000 facets is normal. 3M+ facets indicates corruption.
        MAX_REASONABLE_FACETS = 1000000
        if num_facets > MAX_REASONABLE_FACETS:
            raise ValueError(
                f"Invalid STL file: {filename} - facet count {num_facets:,} is too high. "
                f"Expected < {MAX_REASONABLE_FACETS:,}. File may be corrupted."
            )

        facets = []
        for i in range(num_facets):
            # Read normal (3 floats * 4 bytes = 12 bytes, little endian)
            normal_data = f.read(12)
            if len(normal_data) < 12:
                raise ValueError(f"Invalid STL file: {filename} - normal data is too short at facet {i}")
            normal = struct.unpack('<fff', normal_data)

            # Read vertices (3 vertices * 3 floats * 4 bytes = 36 bytes, little endian)
            v1_data = f.read(12)
            v2_data = f.read(12)
            v3_data = f.read(12)
            if len(v1_data) < 12 or len(v2_data) < 12 or len(v3_data) < 12:
                raise ValueError(f"Invalid STL file: {filename} - vertex data is too short at facet {i}")
            v1 = struct.unpack('<fff', v1_data)
            v2 = struct.unpack('<fff', v2_data)
            v3 = struct.unpack('<fff', v3_data)

            # Read attribute byte count (2 bytes, little endian)
            attribute_data = f.read(2)
            if len(attribute_data) < 2:
                raise ValueError(f"Invalid STL file: {filename} - attribute data is too short at facet {i}")
            attribute = struct.unpack('<H', attribute_data)[0]

            facets.append((normal, v1, v2, v3))

        return facets
```

### 2. Add Pre-conversion Validation in Build Workflow

Add a step to check if STL files exist and have data before attempting conversion:

```yaml
- name: Validate STL files exist
  run: |
    for board in left_pcb right_pcb; do
      if [ ! -f "ergogen/output/3d-models/${board}-3d.stl" ]; then
        echo "Error: ${board}-3d.stl not found"
        exit 1
      fi
      # Check file size (should be > 84 bytes for header + 50 bytes minimum)
      if [ ! -s "ergogen/output/3d-models/${board}-3d.stl" ]; then
        echo "Error: ${board}-3d.stl is empty"
        exit 1
      fi
      # Check file size - warn if file is suspiciously large (corrupted)
      # A typical PCB STL should be < 50MB. Larger files may indicate corruption.
      file_size_mb=$(stat -f%z "ergogen/output/3d-models/${board}-3d.stl" 2>/dev/null || stat -c%s "ergogen/output/3d-models/${board}-3d.stl" 2>/dev/null)
      if [ "$file_size_mb" -gt 50000000 ]; then
        echo "Warning: ${board}-3d.stl file size is ${file_size_mb} bytes (${file_size_mb/1000000/} MB), which is unusually large. This may indicate a corrupted file."
      fi
    done
```

### 3. Add Graceful Failure Handling

If the conversion fails, the workflow should continue or fail with a clear message:

```yaml
- name: Convert STL to ASCII for GitHub markdown
  run: |
    for board in left_pcb right_pcb; do
      if python3 kibot/stl2ascii.py ergogen/output/3d-models/${board}-3d.stl ergogen/output/3d-models/${board}-3d-ascii.stl; then
        echo "✓ Converted ${board}-3d.stl to ASCII"
      else
        echo "✗ Failed to convert ${board}-3d.stl to ASCII"
        echo "This may indicate the STL file is empty or corrupted"
        exit 1
      fi
    done
```

## Implementation Steps

1. **Add error handling to kibot/stl2ascii.py**
   - Validate header length (80 bytes)
   - Validate facet count data (4 bytes)
   - Validate facet count is reasonable (max 1,000,000 facets)
   - Check for sufficient data before each struct.unpack() call
   - Provide clear error messages with file and facet information

2. **Add validation step to .github/workflows/build.yaml**
   - Check if STL files exist before conversion
   - Check if STL files have data (not empty)
   - Warn if file size is suspiciously large (> 50MB)
   - Fail early if files are missing or empty

3. **Update the conversion step in .github/workflows/build.yaml**
   - Use if condition to check conversion success
   - Provide clear error messages

4. **Test locally** by converting a sample STL file
5. **Commit and push** the fix
6. **Verify** the workflow runs successfully in GitHub Actions

## Testing Plan

1. Create a test binary STL file or use an existing one from the project
2. Run `python3 kibot/stl2ascii.py <input.stl> <output.stl>` locally
3. Verify the output ASCII STL file is valid
4. Check that it renders correctly in GitHub markdown
5. Test with empty or malformed STL files to ensure error handling works

## Files to Modify

- `kibot/stl2ascii.py` - Add robust error handling for binary STL reading
- `.github/workflows/build.yaml` - Add validation step and improve error handling in conversion step

## Files to Verify

- `.github/actions/kibot/action.yaml` - Ensure the kibot action works correctly
- `ergogen/output/3d-models/` - Verify STL files are generated properly by KiBot

## Expected Outcome

After the fix:
- The STL to ASCII conversion will complete successfully for valid STL files
- If STL files are empty or corrupted, the workflow will fail with a clear error message
- GitHub Pages will be able to render the 3D models in markdown
- The workflow will pass all steps without silent failures