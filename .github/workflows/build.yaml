on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/*.yaml'
      - '.github/actions/*/action.yaml'
      - 'ergogen/footprints/*.js'
      - 'ergogen/config.yaml'
      - 'kibot/*'
      - 'freerouting/*'
      - 'package.json'
      - '*.nix'
      - 'palmrest_and_tenting_creation/*.py'
      - 'create_full_3d_visual*.py'

name: Build
jobs:
  board:
    runs-on: ubuntu-latest
    name: Generate
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
      - name: Docker Cache
        uses: ScribeMD/docker-cache@0.3.7
        with:
          key: docker-${{ runner.os }}
      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
      - name: Install dependencies
        run: npm install
      - name: Generate unrouted PCBs with Ergogen (definition in package.json)
        run: npm run build
      - name: Run KiBot to generate images, gerbers for the plates
        uses: ./.github/actions/kibot
        with:
          boards: left_pcb right_pcb
          config: default
      # - name: Run KiBot to generate images, gerbers for the unrouted board
      #   uses: ./.github/actions/kibot
      #   with:
      #     boards: left_pcb right_pcb
      #     config: default
      - name: Export DSN file for Freerouting
        uses: ./.github/actions/export-dsn
        with:
          boards: left_pcb right_pcb
      - name: Autoroute PCB
        uses: ./.github/actions/autoroute
        with:
          boards: left_pcb right_pcb
      - name: Import SES
        uses: ./.github/actions/import-ses
        with:
          boards: left_pcb right_pcb
      - name: Run KiBot to generate images, gerbers for the autorouted board
        uses: ./.github/actions/kibot
        with:
          boards: left_pcb right_pcb
          config: boards
      - name: Create filtered output directory structure
        run: |
          # Create all required directories
          sudo mkdir -p filtered-output/pcbs/cad
          sudo mkdir -p filtered-output/pcbs/outlines
          sudo mkdir -p filtered-output/pcbs/pos
          sudo mkdir -p filtered-output/pcbs/gerbers
          sudo mkdir -p filtered-output/pcbs/images
          sudo mkdir -p filtered-output/pcbs/pdfs
          sudo mkdir -p filtered-output/pcbs/3d
          sudo mkdir -p filtered-output/cases
          sudo mkdir -p filtered-output/palmrest
          # Fix ownership so Python scripts can write to these directories
          sudo chown -R $USER:$USER filtered-output
      # - name: Copy OpenJSCAD files to filtered-output/cases
      #   run: |
      #     # Copy all JSCAD files to filtered-output/cases for conversion
      #     cp case_opnjscad/*.js filtered-output/cases/
      #     cp case_opnjscad/*.jscad filtered-output/cases/
      # NOTE: This step is disabled because the correct files are generated by Ergogen
      # and are copied from ergogen/output/cases/ in a later step
      - name: Run KiBot to generate 3D previews
        uses: ./.github/actions/kibot
        with:
          boards: left_pcb right_pcb
          config: 3d_preview
        env:
          KICAD9_3DMODEL_DIR: ${{ github.workspace }}/component_3d_models
          PATH_TO_SWEEPYWAY_COMPONENT_MODELS: ${{ github.workspace }}/component_3d_models
      - name: Run KiBot to generate the pdf from the auto routed board
        uses: ./.github/actions/kibot
        with:
          boards: left_pcb right_pcb
          config: pdf
      - name: Copy PCB files to filtered output
        run: |
          # Copy CAD files
          cp ergogen/output/pcbs/*.kicad_pcb filtered-output/pcbs/cad/ 2>/dev/null || true
          cp ergogen/output/pcbs/*.kicad_prl filtered-output/pcbs/cad/ 2>/dev/null || true
          cp ergogen/output/pcbs/*.kicad_pro filtered-output/pcbs/cad/ 2>/dev/null || true
          cp ergogen/output/pcbs/*.kicad_prl-back filtered-output/pcbs/cad/ 2>/dev/null || true

          # Copy outlines
          rsync -a ergogen/output/outlines/ filtered-output/pcbs/outlines/ 2>/dev/null || true

          # Copy pos files
          rsync -a ergogen/output/pos/ filtered-output/pcbs/pos/ 2>/dev/null || true

          # Copy gerbers
          rsync -a ergogen/output/gerbers/ filtered-output/pcbs/gerbers/ 2>/dev/null || true

          # Copy images
          rsync -a ergogen/output/images/ filtered-output/pcbs/images/ 2>/dev/null || true

          # Copy pdfs
          rsync -a ergogen/output/pdfs/ filtered-output/pcbs/pdfs/ 2>/dev/null || true

          # Copy JSCAD files for OpenJSCAD CLI (already copied earlier, but ensure they're there)
          rsync -a ergogen/output/cases/ filtered-output/cases/ 2>/dev/null || true
      - name: Run KiBot to generate jlpcb pos
        uses: ./.github/actions/kibot
        with:
          boards: left_pcb right_pcb
          config: jlpcb_pos
      - name: Debug - List POS file locations
        run: |
          echo "=== Searching for all .pos files in workspace ==="
          find . -name "*.pos" -type f 2>/dev/null || echo "No .pos files found"
          echo ""
          echo "=== Listing all directories under ergogen/output ==="
          find ergogen/output -type d 2>/dev/null | head -50 || echo "No directories found"
          echo ""
          echo "=== Detailed listing of ergogen/output ==="
          ls -laR ergogen/output/ 2>/dev/null | head -100 || echo "Directory ergogen/output does not exist"
          echo ""
          echo "=== Detailed listing of ergogen/output/pos ==="
          ls -laR ergogen/output/pos/ 2>/dev/null | head -100 || echo "Directory ergogen/output/pos does not exist"
          echo ""
          echo "=== Detailed listing of current working directory ==="
          ls -laR . 2>/dev/null | head -100 || echo "Cannot list current directory"
      - name: Post-process POS files for JLCPCB
        run: |
          # Process files in temp directory (user-owned) to avoid permission issues
          TEMP_DIR=$(mktemp -d)
          for board in left_pcb right_pcb; do
            for side in bottom top; do
              input_file="filtered-output/pcbs/pos/${board}/${board}-${side}_pos.pos"
              output_file="${input_file}-jlcpcb.pos"
              if [ -f "$input_file" ]; then
                # Copy input to temp dir, process, copy output back with sudo
                cp "$input_file" "$TEMP_DIR/temp.pos"
                python kibot/fix_pos_package_name.py "$TEMP_DIR/temp.pos" "$TEMP_DIR/temp-jlcpcb.pos"
                sudo cp "$TEMP_DIR/temp-jlcpcb.pos" "$output_file"
              fi
            done
          done
          rm -rf "$TEMP_DIR"
      - name: Run KiBot to generate jlpcb bom
        uses: ./.github/actions/kibot
        with:
          boards: left_pcb right_pcb
          config: jlpcb_bom
      - name: Copy Ergogen-generated JSCAD files to filtered-output/cases
        run: |
          # Copy JSCAD files generated by Ergogen for OpenJSCAD conversion
          rsync -a ergogen/output/cases/ filtered-output/cases/
          # Verify files were copied successfully
          echo "=== Files in filtered-output/cases/ ==="
          ls -la filtered-output/cases/
      - name: Build OpenJSCAD cli image (for converting jscads to stl)
        run: docker build -t openjscad-cli -f openjscad/Dockerfile openjscad/
      - name: Run OpenJSCAD CLI to convert jscads to stl
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/filtered-output/cases:/designs \
            openjscad-cli \
            bash -c convert-all.sh
      - name: Install UV to prepare python dependencies (for parametric palm rest modeling) 
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true # enable cache to speed up installationshttps://github.com/astral-sh/setup-uv
          version: "0.5.11"
      - name: Install Python dependencies (for parametric palm rest modeling) 
        run: |
          uv sync --all-extras --dev
      - name: Create palmrest 3d model
        run: |
          uv run ./palmrest_and_tenting_creation/create_palmrest.py
      - name: Create tenting system 3d model
        run: |
          uv run ./palmrest_and_tenting_creation/create_tenting_system.py
      - name: Fix GLB unit scale (convert meters â†’ millimeters)
        run: |
          uv run python3 fix_glb_scale.py --verbose
      - name: Create full 3D visual with PCBs, cases, and palm rest
        run: |
          echo "=== Running 3D merge ==="
          
          echo "--- Creating full 3D visualization ---"
          uv run python3 create_full_3d_visual.py || echo "create_full_3d_visual failed"
          
          echo "=== 3D merge completed ==="
          echo "=== Generated files ==="
          ls -la filtered-output/combined_scene*.glb 2>/dev/null || echo "No 3D scene files generated"
      - name: Generate Directory Listings # Create the list of all the github pages to be deployed based on the files on folder.
        uses: jayanta525/github-pages-directory-listing@v4.0.0
        with:
          FOLDER: filtered-output
      - name: Upload filtered output
        uses: actions/upload-artifact@v4
        with:
          name: compressed_keyboard_files
          path: filtered-output
      - name: Persist output for pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: filtered-output/

  deploy-pages:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: board
    
    permissions:
      pages: write
      id-token: write

    environment:
      # environment created automatically by GitHub
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4