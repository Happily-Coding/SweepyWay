on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/*.yaml'
      - '.github/actions/*/action.yaml'
      - 'ergogen/footprints/*.js'
      - 'ergogen/config.yaml'
      - 'kibot/*'
      - 'freerouting/*'
      - 'package.json'
      - '*.nix'
      - 'palmrest_and_tenting_creation/*.py'

name: Build
jobs:
  board:
    runs-on: ubuntu-latest
    name: Generate
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
      - name: Docker Cache
        uses: ScribeMD/docker-cache@0.3.7
        with:
          key: docker-${{ runner.os }}
      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
      - name: Install dependencies
        run: npm install
      - name: Generate unrouted PCBs with Ergogen (definition in package.json)
        run: npm run build
      - name: Run KiBot to generate images, gerbers for the plates
        uses: ./.github/actions/kibot
        with:
          boards: left_pcb right_pcb
          config: default
      # - name: Run KiBot to generate images, gerbers for the unrouted board
      #   uses: ./.github/actions/kibot
      #   with:
      #     boards: left_pcb right_pcb
      #     config: default
      - name: Export DSN file for Freerouting
        uses: ./.github/actions/export-dsn
        with:
          boards: left_pcb right_pcb
      - name: Autoroute PCB
        uses: ./.github/actions/autoroute
        with:
          boards: left_pcb right_pcb
      - name: Import SES
        uses: ./.github/actions/import-ses
        with:
          boards: left_pcb right_pcb
      - name: Run KiBot to generate images, gerbers for the autorouted board
        uses: ./.github/actions/kibot
        with:
          boards: left_pcb right_pcb
          config: boards
      - name: Run KiBot to generate the pdf from the auto routed board
        uses: ./.github/actions/kibot
        with:
          boards: left_pcb right_pcb
          config: pdf
      - name: Make filtered output (excluding fp-info-cache) 1
        run: |
          rsync -a --exclude='fp-info-cache' ergogen/output/ filtered-output/
      - name: Run KiBot to generate jlpcb pos
        uses: ./.github/actions/kibot
        with:
          boards: left_pcb right_pcb
          config: jlpcb_pos
      - name: Debug - List POS file locations
        run: |
          echo "=== Searching for all .pos files in workspace ==="
          find . -name "*.pos" -type f 2>/dev/null || echo "No .pos files found"
          echo ""
          echo "=== Listing all directories under ergogen/output ==="
          find ergogen/output -type d 2>/dev/null | head -50 || echo "No directories found"
          echo ""
          echo "=== Detailed listing of ergogen/output ==="
          ls -laR ergogen/output/ 2>/dev/null | head -100 || echo "Directory ergogen/output does not exist"
          echo ""
          echo "=== Detailed listing of ergogen/output/pos ==="
          ls -laR ergogen/output/pos/ 2>/dev/null | head -100 || echo "Directory ergogen/output/pos does not exist"
          echo ""
          echo "=== Detailed listing of current working directory ==="
          ls -laR . 2>/dev/null | head -100 || echo "Cannot list current directory"
      - name: Post-process POS files for JLCPCB
        run: |
          for board in left_pcb right_pcb; do
            for side in bottom top; do
              input_file="filtered-output/pos/${board}/${board}-${side}_pos.pos"
              if [ -f "$input_file" ]; then
                python kibot/fix_pos_package_name.py "$input_file" "${input_file}-jlcpcb.pos"
              fi
            done
          done
      - name: Run KiBot to generate jlpcb bom
        uses: ./.github/actions/kibot
        with:
          boards: left_pcb right_pcb
          config: jlpcb_bom 
      - name: Build OpenJSCAD cli image (for converting jscads to stl)
        run: docker build -t openjscad-cli -f openjscad/Dockerfile openjscad/
      - name: Run OpenJSCAD CLI to convert jscads to stl
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/filtered-output/cases:/designs \
            openjscad-cli \
            bash -c convert-all.sh
      - name: Install UV to prepare python dependencies (for parametric palm rest modeling) 
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true # enable cache to speed up installationshttps://github.com/astral-sh/setup-uv
          version: "0.5.11"
      - name: Install Python dependencies (for parametric palm rest modeling) 
        run: |
          uv sync --all-extras --dev
      - name: Create palmrest & Tenting system 3d models.
        run: |
          uv run ./palmrest_and_tenting_creation/create_palmrest.py
      - name: Generate Directory Listings # Create the list of all the github pages to be deployed based on the files on folder.
        uses: jayanta525/github-pages-directory-listing@v4.0.0
        with:
          FOLDER: filtered-output
      - name: Upload filtered output
        uses: actions/upload-artifact@v4
        with:
          name: compressed_keyboard_files
          path: filtered-output
      - name: Persist output for pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: filtered-output/

  deploy-pages:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: board
    
    permissions:
      pages: write
      id-token: write

    environment:
      # environment created automatically by GitHub
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4